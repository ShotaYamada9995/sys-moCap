<!DOCTYPE html>
<html lang="zh-cn">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="../libs/mdui/css/mdui.css">
    <link rel="stylesheet" type="text/css" href="../libs/Lato/latofonts.css">

    <script src="../libs/mdui/js/mdui.js"></script>
    <script src="../libs/vue/vue.js"></script>
    <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>

    <!-- import built-in model -->
    <script src="../models/models.js"></script>
</head>

<body
    style="font-family: 'LatoWeb', Helvetica, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', '微软雅黑', Arial, sans-serif;background-color: #fff7;">
    <div id="vue-mount" v-bind:class="'mdui-theme-primary-' + themeColor + ' mdui-theme-accent-' + themeColor">
        <div class="titlebar" style="height: 40px;align-content: center;">
            <button class="clickable" onclick="require('electron').remote.getCurrentWebContents().toggleDevTools()"
                style="height: 30px;position: fixed;left: 0px;top: 5px;display: none;"></button>
            <div class="mdui-color-theme clickable"
                style="height: 24px;width:4px;border-radius: 2px;position: fixed;left: 10px;top: 9px;"
                onclick="require('electron').remote.getCurrentWebContents().toggleDevTools()"></div>
            <div class="dotfont" style="display: inline-block;padding-top: 8px;margin-left: 22px;">Xianfei's<span
                    style="margin-left: 2px;margin-right: 2px;">Mocap</span>System
                <div class="mdui-text-color-theme" style="font-size: 10px;color:#555">视频驱动虚拟角色动作的自动生成系统</div>
            </div>

            <i class="mdui-icon material-icons"
                style="z-index: 1001;position:fixed;top:3px;right:140px;transform: scale(0.6);cursor: pointer;-webkit-app-region: no-drag;"
                onclick="require('electron').remote.getCurrentWebContents().toggleDevTools()">extension</i>

            <div class="clickable tab-bar" style="width: 360px;top:3px;position: fixed;left: calc(50vw - 180px);">
                <button v-bind:class="tab=='model'?'mdui-btn select mdui-text-color-theme':'mdui-btn'"
                    onclick="app.tab='model'"><i class="mdui-icon material-icons">folder_open</i>模型库</button>
                <button v-bind:class="tab=='render'?'mdui-btn select mdui-text-color-theme':'mdui-btn'"
                    onclick="app.tab='render'"><i class="mdui-icon material-icons">filter_center_focus</i>动作捕捉</button>
                <button v-bind:class="tab=='settings'?'mdui-btn select mdui-text-color-theme':'mdui-btn'"
                    onclick="app.tab='settings'"><i class="mdui-icon material-icons">settings</i>设置</button>
            </div>
        </div>
        <div class="line" style="position: fixed;top:40px"></div>
        <div style="padding: 10px 20px;margin-top: 40px;">
            <!-- Model library -->
            <div v-show="tab=='model'">
                <h1 class="mdui-text-color-theme">用户模型</h1>
                <h1 class="mdui-text-color-theme">内建模型</h1>
                <div class="flex-container" id="userModels">
                    <div v-for="model in builtIn" class="mdui-ripple model-item"
                        v-on:click="require('electron').ipcRenderer.send('openModelViewer', {model:model,backgroundColor:bg,color:fg});">
                        <img v-bind:src="model.pic" style="width: 120px;height: 120px;object-fit:contain;">
                        <div style="margin-top: -120px;margin-left: 140px;">
                            <h1>{{model.name}}</h1>
                            <div class="mdui-color-theme"
                                style="width: 35px;height: 18px;border-radius: 5px;margin-top: -8px;font-size: 10px;line-height: 18px;text-align: center;filter: opacity(0.7);">
                                {{model.type.toUpperCase()}}</div>
                        </div>
                    </div>
                    <div v-for="i in [1,2,3,4,5]" class="model-item" style="visibility: hidden;height: 1px;"></div>
                </div>
            </div>
            <!-- render page -->
            <div v-show="tab=='render'">
                <div style="width: 730px;margin: auto;">
                    选择模型：<select class="mdui-select" id="demo-js" v-model="selectModelPath">
                        <option v-for="model in builtIn" v-bind:value="model.path">{{model.name}}</option>
                    </select>
                    <span style="margin-left: 60px;"></span>
                    数据源：
                    <label class="mdui-radio">
                        <input type="radio" name="group1" value="camera" v-model="videoSource" />
                        <i class="mdui-radio-icon"></i>
                        摄像头 </label>
                    <span style="margin-left: 30px;"></span>
                    <label class="mdui-radio">
                        <input type="radio" name="group1" value="file" v-model="videoSource" />
                        <i class="mdui-radio-icon"></i>
                        视频文件
                    </label>

                    <span style="margin-left: 60px;"></span>
                    <button class="mdui-btn mdui-color-theme" onclick="startMocap(this)"><i
                            class="mdui-icon material-icons">play_arrow</i>开始</button>
                    <div style="margin-top: 10px;" v-show="videoSource == 'file'">
                        <button class="mdui-btn mdui-color-theme" id="chooseFile">选择视频文件</button>
                                <span style="margin-left: 10px;">已选择视频文件：{{videoPath==''?'未选择':videoPath}}</span>
                    </div>
                </div>
                <webview nodeIntegration webpreferences="contextIsolation=no" enableremotemodule id="foo"
                    src="about:blank"
                    style="width: calc(100vw - 40px);height: calc((100vw - 40px) * 10 / 32 + 20px);margin-top: 20px;">
                </webview>
            </div>
            <!-- settings page -->
            <div v-show="tab=='settings'" style="max-width: 550px; margin: auto;">
                <div class="dotfont" style="font-size: 32px;color: #555;margin-top: 10px;">Xianfei's<span
                        style="margin-left: 5px;margin-right: 5px;">Mocap</span>System</div>
                <div class="mdui-text-color-theme">视频驱动虚拟角色动作的自动生成系统</div>
                <div style="color: #555;margin-top: 20px;font-size: 14px;">计算机学院 2018级 王衔飞 毕业设计作品</div>
                <div style="height: 20px;"></div>
                <div class="mdui-typo">
                    <blockquote style="margin: 0;">
                        <p>无论走到哪里，都应该记住，过去都是假的，回忆是一条没有尽头的路，一切以往的春天都不复存在，就连那最坚韧而又狂乱的爱情归根结底也不过是一种转瞬即逝的现实。</p>
                        <footer>马尔克斯 ——《百年孤独》</footer>
                    </blockquote>
                </div>
                <div style="height: 20px;"></div>
                <h1 class="mdui-text-color-theme">外观</h1>
                <div class="settings-item">
                    <div style="display: flex;align-content: space-between;justify-content: space-between;width: 100%;">
                        主题颜色：
                        <div v-for="c in ['deep-purple', 'pink','indigo','light-blue','teal','cyan','light-green','amber','orange']"
                            v-bind:class="'color-dot mdui-color-'+c+' mdui-ripple'" v-on:click="themeColor=c"></div>
                        <div></div>
                    </div>
                </div>
                <div class="settings-item">
                    <label class="mdui-switch">
                        <span>使用毛玻璃效果</span>
                        <input type="checkbox" />
                        <i class="mdui-switch-icon"></i>
                    </label>
                </div>
                <h1 class="mdui-text-color-theme">实时预览</h1>
                <div class="settings-item">
                    <label class="mdui-switch">
                        <span>对输入源进行骨骼可视化标记</span>
                        <input type="checkbox" checked />
                        <i class="mdui-switch-icon"></i>
                    </label>
                </div>
                <div class="settings-item">
                    <label class="mdui-switch">
                        <span>当输入源为摄像头时，进行水平镜像翻转</span>
                        <input type="checkbox" checked />
                        <i class="mdui-switch-icon"></i>
                    </label>
                </div>
                <div class="settings-item">
                    <label class="mdui-switch">
                        <span>当输入源为视频文件时，进行水平镜像翻转</span>
                        <input type="checkbox" checked />
                        <i class="mdui-switch-icon"></i>
                    </label>
                </div>
                <h1 class="mdui-text-color-theme">虚拟形象输出</h1>
                <div class="settings-item">
                    <label class="mdui-switch">
                        <span>启用抗锯齿</span>
                        <input type="checkbox" />
                        <i class="mdui-switch-icon"></i>
                    </label>
                </div>
                <div class="settings-item">
                    <label class="mdui-switch">
                        <span>使用图片作为背景而不是纯色</span>
                        <input type="checkbox" />
                        <i class="mdui-switch-icon"></i>
                    </label>
                </div>
                <div class="settings-item">
                    <label>
                        <span>背景颜色</span>
                        <input type="color" value="#ffffff"
                            style="background: none;border: none;padding:0;width: 40px;height: 25px;">
                    </label>
                </div>
                <div class="settings-item">
                    <span>背景图片（点击更换）</span>
                </div>
                <h1 class="mdui-text-color-theme">动作捕捉<span
                        style="color: #777;font-size: 12px;font-weight: 400;margin-left: 10px;">Powered by Google
                        MideaPipe</span></h1>
                <div class="settings-item">
                    <span style="display: inline-block;width: 56%;">MODEL_COMPLEXITY
                        <i class="mdui-icon material-icons"
                            mdui-tooltip="{content: 'Complexity of the pose landmark model: 0, 1 or 2. Landmark accuracy as well as inference latency generally go up with the model complexity. Default to 1.'}">help_outline</i>
                    </span>
                    <label class="mdui-slider mdui-slider-discrete"
                        style="display: inline-block;width: 40%;margin-bottom: -12px;">
                        <input type="range" step="1" min="0" max="2" value="2" />
                    </label>
                </div>
                <div class="settings-item">
                    <label class="mdui-switch">
                        <span>SMOOTH_LANDMARKS
                            <i class="mdui-icon material-icons"
                                mdui-tooltip="{content: 'If set to true, the solution filters pose landmarks across different input images to reduce jitter. Default to true.'}">help_outline</i>
                        </span>
                        <input type="checkbox" checked />
                        <i class="mdui-switch-icon"></i>
                    </label>
                </div>
                <div class="settings-item">
                    <label class="mdui-switch">
                        <span>REFINE_FACE_LANDMARKS
                            <i class="mdui-icon material-icons"
                                mdui-tooltip="{content: 'Whether to further refine the landmark coordinates around the eyes and lips, and output additional landmarks around the irises. Default to false.'}">help_outline</i>
                        </span>
                        <input type="checkbox" checked />
                        <i class="mdui-switch-icon"></i>
                    </label>
                </div>
                <div class="settings-item">
                    <span style="display: inline-block;width: 56%;">MIN_DETECTION_CONFIDENCE
                        <i class="mdui-icon material-icons"
                            mdui-tooltip="{content: 'Minimum confidence value ([0.0, 1.0]) from the person-detection model for the detection to be considered successful. Default to 0.5.'}">help_outline</i>
                    </span>
                    <label class="mdui-slider mdui-slider-discrete"
                        style="display: inline-block;width: 40%;margin-bottom: -12px;">
                        <input type="range" step="0.1" min="0" max="1" value="0.7" />
                    </label>
                </div>
                <div class="settings-item">
                    <span style="display: inline-block;width: 56%;">MIN_TRACKING_CONFIDENCE
                        <i class="mdui-icon material-icons"
                            mdui-tooltip="{content: 'Minimum confidence value ([0.0, 1.0]) from the landmark-tracking model for the pose landmarks to be considered tracked successfully, or otherwise person detection will be invoked automatically on the next input image. Setting it to a higher value can increase robustness of the solution, at the expense of a higher latency. Default to 0.5.'}">help_outline</i>
                    </span>
                    <label class="mdui-slider mdui-slider-discrete"
                        style="display: inline-block;width: 40%;margin-bottom: -12px;">
                        <input type="range" step="0.1" min="0" max="1" value="0.7" />
                    </label>
                </div>
                <h1 class="mdui-text-color-theme">开发者</h1>
                <div class="settings-item">
                    <label class="mdui-switch">
                        <span>显示DevTools入口</span>
                        <input type="checkbox" />
                        <i class="mdui-switch-icon"></i>
                    </label>
                </div>
            </div>
        </div>
    </div>

    <script>
        const storage = require('electron-localstorage');
        var remote = require('electron').remote;
        storage.setStoragePath(remote.getGlobal('storagePath').extra);

        Vue.config.ignoredElements = ['model-viewer']
        var app = new Vue({
            el: '#vue-mount',
            data: {
                tab: 'model',
                themeColor: 'deep-purple',
                builtIn: builtInModels,
                selectModelPath: builtInModels[0].path,
                videoSource: 'camera',
                videoPath:'',
            },
            computed: {
                bg: function () {
                    this.themeColor
                    return window.getComputedStyle(document.querySelector('.mdui-color-theme'), null).backgroundColor
                },
                fg: function () {
                    this.themeColor
                    return window.getComputedStyle(document.querySelector('.mdui-color-theme'), null).color
                }
            }
        })
        
        document.getElementById("chooseFile").onclick = async function () {
				const result = await remote.dialog.showOpenDialogSync({
					properties: ['openFile'],
					filters: [{
						name: '视频文件',
						extensions: ['mp4', 'webm']
					}],
				});
				if (result)  app.videoPath = result
		}

        var inst = new mdui.Select('#demo-js');

        function startMocap(e) {
            if (e.innerHTML.indexOf('开始') != -1) {
                localStorage.setItem('modelPath', app.selectModelPath);
                localStorage.setItem('useCamera', app.videoSource);
                localStorage.setItem('videoFile', app.videoPath[0]);
                document.getElementById('foo').src = '../render/render.html'
                e.innerHTML = '<i class="mdui-icon material-icons">stop</i>停止'
            } else {
                document.getElementById('foo').src = 'about:blank'
                e.innerHTML = '<i class="mdui-icon material-icons">play_arrow</i>开始'
            }
        }
    </script>
</body>

</html>